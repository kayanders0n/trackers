SET TERM !! ;

CREATE OR ALTER TRIGGER ACTIVITY_UPDATE FOR ACTIVITY
ACTIVE BEFORE UPDATE POSITION 0
AS
BEGIN
  IF (NEW.USERID IS DISTINCT FROM OLD.USERID) THEN EXCEPTION GOT_HERE 'Cannot change UserId.';
  IF (NEW.TITLEID IS DISTINCT FROM OLD.TITLEID) THEN EXCEPTION GOT_HERE 'Cannot change Title.';  
  IF (NEW.CREATEDON IS DISTINCT FROM OLD.CREATEDON) THEN EXCEPTION GOT_HERE 'Cannot change Created On Date.';
  IF (NEW.STARTDATE IS NULL AND NEW.FINISHDATE IS NULL) THEN EXCEPTION FIELD_REQUIRED 'Start or Finish Date is required.';

  IF (NEW.FINISHDATE IS NULL) THEN
    NEW.COMPLETED = 0;
  ELSE BEGIN
    NEW.COMPLETED = 1;
    IF (NEW.STARTDATE IS NULL) THEN NEW.STARTDATE = NEW.FINISHDATE;
  END

  IF (NEW.NOTES IS NULL OR TRIM(NEW.NOTES) = '') THEN NEW.NOTES = '';
  NEW.MODIFIEDON = CURRENT_TIMESTAMP;
END
!!

SET TERM ; !!