/******************************************************************************/
/****        Generated by IBExpert 2021.12.6.1 7/7/2025 1:35:42 PM         ****/
/******************************************************************************/

/******************************************************************************/
/****     Following SET SQL DIALECT is just for the Database Comparer      ****/
/******************************************************************************/
SET SQL DIALECT 3;



/******************************************************************************/
/****                              Generators                              ****/
/******************************************************************************/

CREATE GENERATOR GEN_ACTIVITY_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_DAILYLOG_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_ENTITY_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_GENRE_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_LISTITEMS_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_LISTTYPE_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_LIST_ID START WITH 100 INCREMENT BY 1;
CREATE GENERATOR GEN_PEOPLE_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_SERIES_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_TITLE_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_USERS_ID START WITH 1 INCREMENT BY 1;
CREATE GENERATOR GEN_USER_RATING_ID START WITH 1 INCREMENT BY 1;


/******************************************************************************/
/****                              Exceptions                              ****/
/******************************************************************************/

CREATE EXCEPTION FIELD_REQUIRED 'This field is required.';

CREATE EXCEPTION GOT_HERE 'Got here.';



/******************************************************************************/
/****                                Tables                                ****/
/******************************************************************************/



CREATE TABLE ACTIVITY (
    ID          INTEGER NOT NULL,
    USERID      INTEGER NOT NULL,
    TITLEID     INTEGER NOT NULL,
    STARTDATE   DATE,
    FINISHDATE  DATE,
    COMPLETED   INTEGER DEFAULT 0,
    NOTES       VARCHAR(500),
    CREATEDON   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MODIFIEDON  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE AUTHOR (
    TITLEID   INTEGER NOT NULL,
    PEOPLEID  INTEGER NOT NULL,
    ORDERID   INTEGER
);

CREATE TABLE DAILYLOG (
    ID            INTEGER NOT NULL,
    USERID        INTEGER NOT NULL,
    TITLEID       INTEGER NOT NULL,
    ACTIVITYDATE  DATE NOT NULL,
    PROGRESS      INTEGER,
    UOMID         INTEGER,
    COMMENT       VARCHAR(300)
);

CREATE TABLE ENTITY (
    ID        INTEGER NOT NULL,
    DESCRIPT  VARCHAR(50) NOT NULL,
    TYPEID    INTEGER
);

CREATE TABLE GENRE (
    ID               INTEGER NOT NULL,
    DESCRIPT         VARCHAR(25) NOT NULL,
    ISENTERTAINMENT  INTEGER,
    ISBOOK           INTEGER
);

CREATE TABLE LIST (
    ID            INTEGER NOT NULL,
    USERID        INTEGER NOT NULL,
    DESCRIPT      VARCHAR(25) NOT NULL,
    LONGDESCRIPT  VARCHAR(50),
    TYPEID        INTEGER NOT NULL,
    ISPRIVATE     INTEGER DEFAULT 0,
    LISTTYPEID    INTEGER DEFAULT 0,
    CREATEDON     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MODIFIEDON    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE LISTITEMS (
    ID         INTEGER NOT NULL,
    LISTID     INTEGER NOT NULL,
    TITLEID    INTEGER NOT NULL,
    CREATEDON  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    SORTORDER  INTEGER
);

CREATE TABLE LISTTYPE (
    ID        INTEGER NOT NULL,
    DESCRIPT  VARCHAR(25) NOT NULL,
    TYPEID    INTEGER NOT NULL
);

CREATE TABLE PEOPLE (
    ID         INTEGER NOT NULL,
    FIRSTNAME  VARCHAR(25),
    LASTNAME   VARCHAR(25)
);

CREATE TABLE PLATFORM (
    TITLEID   INTEGER NOT NULL,
    ENTITYID  INTEGER NOT NULL,
    ORDERID   INTEGER
);

CREATE TABLE PRODUCTION (
    TITLEID   INTEGER NOT NULL,
    ENTITYID  INTEGER NOT NULL,
    ORDERID   INTEGER
);

CREATE TABLE SERIES (
    ID        INTEGER NOT NULL,
    DESCRIPT  VARCHAR(50) NOT NULL
);

CREATE TABLE TITLE (
    ID            INTEGER NOT NULL,
    DESCRIPT      VARCHAR(50) NOT NULL,
    TYPEID        INTEGER NOT NULL,
    SERIESID      INTEGER,
    ORDERID       DOUBLE PRECISION,
    FIRSTRELEASE  DATE,
    CONTENT_SIZE  INTEGER,
    UOMID         INTEGER,
    IMAGEFILE     VARCHAR(250)
);

CREATE TABLE TITLEGENRE (
    TITLEID  INTEGER NOT NULL,
    GENREID  INTEGER NOT NULL,
    ORDERID  INTEGER
);

CREATE TABLE TYPECODES (
    ID        INTEGER NOT NULL,
    DESCRIPT  VARCHAR(10)
);

CREATE TABLE UOM (
    ID        INTEGER NOT NULL,
    DESCRIPT  VARCHAR(10) NOT NULL
);

CREATE TABLE USER_RATING (
    ID          INTEGER NOT NULL,
    USERID      INTEGER NOT NULL,
    TITLEID     INTEGER NOT NULL,
    RATING      DOUBLE PRECISION,
    REVIEW      VARCHAR(2000),
    HIDE        INTEGER DEFAULT 0,
    CREATEDON   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MODIFIEDON  TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE USERS (
    ID             INTEGER NOT NULL,
    FIRSTNAME      VARCHAR(50) NOT NULL,
    LASTNAME       VARCHAR(50) NOT NULL,
    USERNAME       VARCHAR(50) NOT NULL,
    PASSWORD_HASH  VARCHAR(255) NOT NULL,
    EMAIL          VARCHAR(100),
    CREATEDON      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    MODIFIEDON     TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);



/******************************************************************************/
/****                          Unique constraints                          ****/
/******************************************************************************/

ALTER TABLE AUTHOR ADD UNIQUE (TITLEID, PEOPLEID);
ALTER TABLE PLATFORM ADD UNIQUE (TITLEID, ENTITYID);
ALTER TABLE PRODUCTION ADD UNIQUE (TITLEID, ENTITYID);
ALTER TABLE TITLEGENRE ADD UNIQUE (TITLEID, GENREID);
ALTER TABLE USERS ADD UNIQUE (USERNAME);


/******************************************************************************/
/****                             Primary keys                             ****/
/******************************************************************************/

ALTER TABLE ACTIVITY ADD PRIMARY KEY (ID);
ALTER TABLE DAILYLOG ADD PRIMARY KEY (ID);
ALTER TABLE ENTITY ADD PRIMARY KEY (ID);
ALTER TABLE GENRE ADD PRIMARY KEY (ID);
ALTER TABLE LIST ADD PRIMARY KEY (ID);
ALTER TABLE LISTITEMS ADD PRIMARY KEY (ID);
ALTER TABLE LISTTYPE ADD PRIMARY KEY (ID);
ALTER TABLE PEOPLE ADD PRIMARY KEY (ID);
ALTER TABLE SERIES ADD PRIMARY KEY (ID);
ALTER TABLE TITLE ADD PRIMARY KEY (ID);
ALTER TABLE TYPECODES ADD PRIMARY KEY (ID);
ALTER TABLE UOM ADD PRIMARY KEY (ID);
ALTER TABLE USERS ADD PRIMARY KEY (ID);
ALTER TABLE USER_RATING ADD PRIMARY KEY (ID);


/******************************************************************************/
/****                               Triggers                               ****/
/******************************************************************************/



SET TERM ^ ;



/******************************************************************************/
/****                         Triggers for tables                          ****/
/******************************************************************************/



/* Trigger: ACTIVITY_INSERT */
CREATE OR ALTER TRIGGER ACTIVITY_INSERT FOR ACTIVITY
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_ACTIVITY_ID,1);
END
^

/* Trigger: DAILYLOG_INSERT */
CREATE OR ALTER TRIGGER DAILYLOG_INSERT FOR DAILYLOG
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_DAILYLOG_ID,1);
END
^

/* Trigger: ENTITY_INSERT */
CREATE OR ALTER TRIGGER ENTITY_INSERT FOR ENTITY
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.DESCRIPT IS NULL OR TRIM(NEW.DESCRIPT) = '') THEN EXCEPTION FIELD_REQUIRED 'Entity Name is required.';
  IF (NEW.TYPEID IS NULL) THEN EXCEPTION FIELD_REQUIRED 'Entity Type is required.';

  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_ENTITY_ID,1);
END
^

/* Trigger: GENRE_INSERT */
CREATE OR ALTER TRIGGER GENRE_INSERT FOR GENRE
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.DESCRIPT IS NULL OR TRIM(NEW.DESCRIPT) = '') THEN EXCEPTION FIELD_REQUIRED 'Genre Name is required.';

  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_GENRE_ID,1);
  IF (NEW.ISENTERTAINMENT IS NULL) THEN NEW.ISENTERTAINMENT = 0;
  IF (NEW.ISBOOK IS NULL) THEN NEW.ISBOOK = 0;
END
^

/* Trigger: LISTITEMS_INSERT */
CREATE OR ALTER TRIGGER LISTITEMS_INSERT FOR LISTITEMS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_LISTITEMS_ID,1);
END
^

/* Trigger: LISTTYPE_INSERT */
CREATE OR ALTER TRIGGER LISTTYPE_INSERT FOR LISTTYPE
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_LISTTYPE_ID,1);
END
^

/* Trigger: LIST_INSERT */
CREATE OR ALTER TRIGGER LIST_INSERT FOR LIST
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_LIST_ID,1);
END
^

/* Trigger: SERIES_INSERT */
CREATE OR ALTER TRIGGER SERIES_INSERT FOR SERIES
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.DESCRIPT IS NULL OR TRIM(NEW.DESCRIPT) = '') THEN EXCEPTION FIELD_REQUIRED 'Series Name is required.';

  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_SERIES_ID,1);
END
^

/* Trigger: TITLE_INSERT */
CREATE OR ALTER TRIGGER TITLE_INSERT FOR TITLE
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.DESCRIPT IS NULL OR TRIM(NEW.DESCRIPT) = '') THEN EXCEPTION FIELD_REQUIRED 'Title is required.';
  IF (NEW.TYPEID IS NULL) THEN EXCEPTION FIELD_REQUIRED 'Media Type is required.';
  IF (NEW.CONTENT_SIZE > 0 AND NEW.UOMID IS NULL) THEN EXCEPTION FIELD_REQUIRED 'Unit of Measure is required.';

  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_TITLE_ID,1);
  IF (NEW.CONTENT_SIZE IS NULL) THEN NEW.CONTENT_SIZE = 0;
  IF (NEW.IMAGEFILE IS NULL) THEN NEW.IMAGEFILE = '';
END
^

/* Trigger: USERS_INSERT */
CREATE OR ALTER TRIGGER USERS_INSERT FOR USERS
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_USERS_ID,1);
END
^

/* Trigger: USER_RATING_INSERT */
CREATE OR ALTER TRIGGER USER_RATING_INSERT FOR USER_RATING
ACTIVE BEFORE INSERT POSITION 0
AS
BEGIN
  IF (NEW.USERID IS NULL) THEN EXCEPTION FIELD_REQUIRED 'UserId is required.';
  IF (NEW.TITLEID IS NULL) THEN EXCEPTION FIELD_REQUIRED 'TitleId is required.';
  IF (NEW.RATING IS NULL) THEN EXCEPTION FIELD_REQUIRED 'Rating is required.';
  IF (NEW.RATING < 0 OR NEW.RATING > 5) THEN EXCEPTION GOT_HERE 'Rating must be 0 to 5.';

  IF (NEW.ID IS NULL) THEN NEW.ID = GEN_ID(GEN_USER_RATING_ID,1);
  IF (NEW.REVIEW IS NULL OR TRIM(NEW.REVIEW) = '') THEN NEW.REVIEW = '';
  IF (NEW.HIDE IS NULL) THEN NEW.HIDE = 0;
  NEW.CREATEDON = CURRENT_TIMESTAMP;
  NEW.MODIFIEDON = CURRENT_TIMESTAMP;
END
^
SET TERM ; ^

